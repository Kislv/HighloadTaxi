# HighloadTaxi
**1. Тема и целевая аудитория**

Тема: сервис такси

*Функционал MVP*
1. Создание заказа такси
2. Отслеживание ближайших свободных машин
3. Подсчет цены, примерного времени поездки для заданного маршрута

*Целевая аудитория*

Возрастная категория:14-80 лет,

Местоположение: СНГ.

[Аудитория составляет 35 млн. активных пользователей в месяц](https://inclient.ru/yandex-stats/#:~:text=%D0%90%D1%83%D0%B4%D0%B8%D1%82%D0%BE%D1%80%D0%B8%D1%8F%20%D0%AF%D0%BD%D0%B4%D0%B5%D0%BA%D1%81%20%D0%A2%D0%B0%D0%BA%D1%81%D0%B8,%D0%AF%D0%BD%D0%B4%D0%B5%D0%BA%D1%81%2C%202022)

**2. Расчет нагрузки**

*Продуктовые метрики*

Месячная аудитория: 35 млн.

Дневная аудитория: 1.2 млн.


Человек отслеживает ближайшие свободные машины до заказа и во время ожидания, это время примерно равно [4 мин.](https://yandex.ru/company/researches/2015/moscow/taxi#:~:text=%D0%A1%D1%80%D0%B5%D0%B4%D0%BD%D0%B5%D0%B5%20%D0%B2%D1%80%D0%B5%D0%BC%D1%8F%20%D0%BE%D0%B6%D0%B8%D0%B4%D0%B0%D0%BD%D0%B8%D1%8F%20%D0%B7%D0%B0%D0%BA%D0%B0%D0%B7%D0%B0%20%D0%B2%20%D0%AF%D0%BD%D0%B4%D0%B5%D0%BA%D1%81.%D0%A2%D0%B0%D0%BA%D1%81%D0%B8%20%E2%80%94%204%20%D0%BC%D0%B8%D0%BD%D1%83%D1%82%D1%8B)
(Стоит учитывать, что не все пользователи отслеживают машины после заказа, но до приезда авто)

Каждому пользователю, который зашел в приложение, показывается карта с расположением автомобилей, эта информация обновляется примерно 1 раз в минуту исходя из собственных замеров.

Пользователь может заходить в несколько приложений для такси, чтобы сравнить цены на поездку, учитывая это, примем значение открытия приложения без заказа такси в день равным 2.
Самые популярные направления для поездок - [аэропорты](https://yandex.ru/company/researches/2015/spb/taxi), университеты, [торговые центры](https://yandex.ru/company/researches/2015/moscow/taxi#:~:text=%D0%A1%D1%80%D0%B5%D0%B4%D0%BD%D0%B5%D0%B5%20%D0%B2%D1%80%D0%B5%D0%BC%D1%8F%20%D0%BE%D0%B6%D0%B8%D0%B4%D0%B0%D0%BD%D0%B8%D1%8F%20%D0%B7%D0%B0%D0%BA%D0%B0%D0%B7%D0%B0%20%D0%B2%20%D0%AF%D0%BD%D0%B4%D0%B5%D0%BA%D1%81.%D0%A2%D0%B0%D0%BA%D1%81%D0%B8%20%E2%80%94%204%20%D0%BC%D0%B8%D0%BD%D1%83%D1%82%D1%8B), следовательно, человек поедет в одну сторону и, скорее всего, обратно, поэтому имеет смысл предположить, что один пользователь в среднем делает 2, иногда 1 поездки в день, поэтому примем значение среднего количества поездок в день, сделанные одним пользователем - 1.8.
Человек ждет машину в среднем 4 минуты, совершает 1.8 поездок в день, 2 раза заходит в сервис без заказа такси. В итоге получается, что он получает информацию о свободных машинах 1.8 * 4 + 2 = 9.2 раза.

Если человек делает в среднем 1.8 заказов такси, 2 раза смотрит цену поездки в день, то всего он использует подсчет цены, примерное время поездки для заданного маршрута - 1.8 + 2 = 3.8 раз. 

|Заказ такси|Отслеживание ближайших свободных машин|Подсчет цены, примерного времени поездки для заданного маршрута|
|--|--|--|
|1.8|9.2|3.8|

*Технические метрики*

Всего пользователей скачало приложение - [100 млн](https://play.google.com/store/apps/details?id=ru.yandex.taxi&hl=ru&gl=US#:~:text=5%2C91%C2%A0%D0%BC%D0%BB%D0%BD%20%D0%BE%D1%82%D0%B7%D1%8B%D0%B2%D0%BE%D0%B2-,100%C2%A0%D0%BC%D0%BB%D0%BD%2B,-%D0%9A%D0%BE%D0%BB%D0%B8%D1%87%D0%B5%D1%81%D1%82%D0%B2%D0%BE%20%D1%81%D0%BA%D0%B0%D1%87%D0%B8%D0%B2%D0%B0%D0%BD%D0%B8%D0%B9)
Для каждого пользователя требуется хранить следующие свойства:
- id (целое число, 4 байта)
- фото (изображение, 5 Мб);
- имя (строка, 100 байт);
- email (строка, 100 байт);
- номер телефона (строка, 40 байт);
- рейтинг пользователя (число с плавающей точкой, 4 байта);
- текущая широта (число с плавающей точкой, 8 байта)
- текущая долгота (число с плавающей точкой, 8 байта)
- избранные места (список из мест, каждое место хранится в виде: долгота (число с плавающей точкой, 4 байта), широта (число с плавающей точкой, 4 байта), название (строка, 100 байт));
- история заказов (список заказов, каждый заказ состоит из id пассажира (целое число, 4 байта), id водителя (целое число, 4 байта), id автомобиля (целое число, 4 байта),продолжительность поездки (целое число, 4 байта), цена поездки (целое число (4 байта), оценка водителя (целое число, 1 байт), оценка клиента (целое число, 1 байт), маршрут поездки (чтобы описать маршрут, необходимо знать точки начала и конца маршрута, все ветвления дорог, через которые проложен маршрут. Среднаяя продолжительность поездки - [15 км](https://yandex.ru/company/researches/2013/ya_moscow_taxi_2013#:~:text=%D0%A1%D1%80%D0%B5%D0%B4%D0%BD%D0%B5%D0%B5%20%D1%80%D0%B0%D1%81%D1%81%D1%82%D0%BE%D1%8F%D0%BD%D0%B8%D0%B5%20%D0%BF%D0%BE%D0%B5%D0%B7%D0%B4%D0%BA%D0%B8%20%D0%B4%D0%BD%D0%B5%D0%BC%20%D0%BF%D0%BE%20%D0%B1%D1%83%D0%B4%D0%BD%D1%8F%D0%BC%20%D1%81%D0%BE%D1%81%D1%82%D0%B0%D0%B2%D0%BB%D1%8F%D0%B5%D1%82%20%D0%BE%D0%BA%D0%BE%D0%BB%D0%BE%2013%20%D0%BA%D0%BC%2C%20%D0%B0%20%D0%B2%20%D0%B2%D1%8B%D1%85%D0%BE%D0%B4%D0%BD%D1%8B%D0%B5%20%D0%B8%20%D0%BD%D0%BE%D1%87%D1%8C%D1%8E%20%E2%80%94%2017%2C5%20%D0%BA%D0%BC.) - пусть ветвление встречается 1 раз на 50 метров. Одна точка на карте состоит из 2 чисел в плавающей точкой, тогда для описания всего маршрута в среднем уходит (300 + 2) * 4 * 2 = 2 416 байт;
- данные платежной карты (номер карты - 8 байт, cvv-код - 1 байт, дата выдачи карты - 4 байта, имя  - 50 байт, фамилия - 50 байт);

Всего водителей в сервисе - [700 000](https://www.vedomosti.ru/business/articles/2020/10/01/841894-yandekstaksi-zapustilo#:~:text=%D0%92%D1%81%D0%B5%D0%B3%D0%BE%20%D0%B2%2012%20%D1%81%D1%82%D1%80%D0%B0%D0%BD%D0%B0%D1%85%2C%20%D0%B3%D0%B4%D0%B5%20%D0%BF%D1%80%D0%B8%D1%81%D1%83%D1%82%D1%81%D1%82%D0%B2%D1%83%D0%B5%D1%82%20%D1%81%D0%B5%D1%80%D0%B2%D0%B8%D1%81%20(%D0%91%D0%B5%D0%BB%D0%BE%D1%80%D1%83%D1%81%D1%81%D0%B8%D0%B8%2C%20%D0%90%D1%80%D0%BC%D0%B5%D0%BD%D0%B8%D0%B8%2C%20%D0%93%D1%80%D1%83%D0%B7%D0%B8%D0%B8%2C%20%D0%9A%D0%B0%D0%B7%D0%B0%D1%85%D1%81%D1%82%D0%B0%D0%BD%D0%B5%2C%20%D0%9A%D0%B8%D1%80%D0%B3%D0%B8%D0%B7%D0%B8%D0%B8%2C%20%D0%A3%D0%B7%D0%B1%D0%B5%D0%BA%D0%B8%D1%81%D1%82%D0%B0%D0%BD%D0%B5%2C%20%D0%AD%D1%81%D1%82%D0%BE%D0%BD%D0%B8%D0%B8%2C%20%D0%9B%D0%B0%D1%82%D0%B2%D0%B8%D0%B8%2C%20%D0%9B%D0%B8%D1%82%D0%B2%D0%B5%2C%20%D0%A1%D0%B5%D1%80%D0%B1%D0%B8%D0%B8%20%D0%B8%20%D0%9C%D0%BE%D0%BB%D0%B4%D0%B0%D0%B2%D0%B8%D0%B8)%2C%20%D0%B2%20%D0%BD%D0%B5%D0%BC%20%D1%80%D0%B0%D0%B1%D0%BE%D1%82%D0%B0%D0%B5%D1%82%20700%C2%A0000%20%D0%B0%D0%BA%D1%82%D0%B8%D0%B2%D0%BD%D1%8B%D1%85%20%D0%B2%D0%BE%D0%B4%D0%B8%D1%82%D0%B5%D0%BB%D0%B5%D0%B9.)

Для водителя требуется хранить следующие данные:
- фото (изображение, 5 Мб);
- имя (строка, 100 байт);
- email (строка, 100 байт);
- номер телефона (строка, 40 байт);
- рейтинг водителя (число с плавающей точкой, 4 байта);
- категория прав (символ, 1 байт)
- текущая широта (число с плавающей точкой, 8 байта)
- текущая долгота (число с плавающей точкой, 8 байта)
- Информация о машине (1. Название модели (строка, 100 байт), название производителя (строка, 100 байт), год выпуска (целочисленное поле, 2 байта), состояние (символ, 1 байт))
- история заказов (аналагочно клиентской)
- данные платежной карты (номер карты - 8 байт, cvv-код - 1 байт, дата выдачи карты - 4 байта, имя  - 50 байт, фамилия - 50 байт);


Рассчет количества даных по типам :
Не каждый пользователь ставит аватарку, возьмем, что её ставят 50%, в среднем аватарка весит 1 Мб
Бинарные данные: 1 Мб * 50 000 000 = 10 000 Тб

У каждого пользователя примерно 2 избранных места.
Сейчас каждый месяц совершается около 2 млн. поездок, раньше эта цифра была меньше, однако этот сервис существует с 2011 года, так что разумно предположить, что за всю историю сервиса было ~500 млн заказов.

Данные с плавающей точкой: 32 байт * 100 000 000 + 2 416 байт * 500 000 000 = 1.211 Тб

строки

На одного пользователя приходится 440 байт строковых данных, для водителей аналогично
Строковые данные: 440 байт * (100 000 000 + 700 000) = 44.3 Гб



Размер хранения в разбивке по типам данных (в Тб):

|Бинарные|С плавающей точкой|
|--|--|
|100 00|1.2|

[Пиковое время для сервиса такси - вечера пятницы и субботы с 18:00 до 23:00 - в этот период совершается в 2 раза больше заказов, чем в рабочие часы по будням](https://yandex.ru/company/researches/2015/moscow/taxi#:~:text=%D0%9D%D0%B5%D0%B4%D0%B5%D0%BB%D1%8C%D0%BD%D1%8B%D0%B5%20%D0%BF%D0%B8%D0%BA%D0%B8%20%D0%BF%D1%80%D0%B8%D1%85%D0%BE%D0%B4%D1%8F%D1%82%D1%81%D1%8F%20%D0%BD%D0%B0%20%D0%B2%D0%B5%D1%87%D0%B5%D1%80%D0%B0%20%D0%BF%D1%8F%D1%82%D0%BD%D0%B8%D1%86%D1%8B%20%D0%B8%20%D1%81%D1%83%D0%B1%D0%B1%D0%BE%D1%82%D1%8B%2C%20%D1%81%2018%3A00%20%D0%B4%D0%BE%2023%3A00%20%E2%80%94%20%D0%B2%20%D1%8D%D1%82%D0%BE%D1%82%20%D0%BF%D0%B5%D1%80%D0%B8%D0%BE%D0%B4%20%D0%BC%D0%BE%D1%81%D0%BA%D0%B2%D0%B8%D1%87%D0%B8%20%D0%B4%D0%B5%D0%BB%D0%B0%D1%8E%D1%82%20%D0%B2%201%2C5%E2%80%932%20%D1%80%D0%B0%D0%B7%D0%B0%20%D0%B1%D0%BE%D0%BB%D1%8C%D1%88%D0%B5%20%D0%B7%D0%B0%D0%BA%D0%B0%D0%B7%D0%BE%D0%B2%2C%20%D1%87%D0%B5%D0%BC%20%D0%B2%20%D1%80%D0%B0%D0%B1%D0%BE%D1%87%D0%B8%D0%B5%20%D1%87%D0%B0%D1%81%D1%8B%20%D0%BF%D0%BE%20%D0%B1%D1%83%D0%B4%D0%BD%D1%8F%D0%BC.)

Расчет количества запросов в день:
- заказ такси - 1.8 * 1.2 млн = 2.16 млн
- местоположение автомобилей - 9.2 * 1.2 млн = 11.04 млн
- подсчет цены, примерного времени поездки для заданного маршрута - 3.8 * 1.2 млн = 4.56 млн

Заказ такси требует передачи следующих данных
на сервер:
- id клиента (4 байта);
- точки начала и конца маршрута (32 байт);
- цена (4 байта);
от сервера:
- подтверждение заказа - 1 байт;

Запрос местоположения автомобилей требует передачи следующих данных 
на сервер:
- центр области карты, куда смотрит клиент - 16 байта;
- масштаб карты - 4 байта;
от сервера:
- местоположение ~4 автомобилей и их направление - 68 байт;

Запрос подсчета цены, примерного времени поездки для заданного маршрута
на сервер:
- id клиента (4 байта);
- точки начала и конца маршрута (16 байт);
от сервера:
- цена (4 байта)
- примерное время поездки (4 байта)
- примерное время ожидания автомобиля (4 байта)

<!-- (2.16 млн * 40 байт + 11.04 млн * 20 байт + 4.56 млн * 20 байт) / 24 / 60 / 60 с * 8 * 2-->
<!-- (2.16 млн * 1 байт + 11.04 млн * 68 байт + 4.56 млн * 12 байт) / 24 / 60 / 60 с * 8 * 2 -->
Пиковое потребление в течении суток (Гбит/c):
|на сервер|от сервера|
|--|--|
|0.07|0.15|

<!-- (2.16 млн * 40 байт + 11.04 млн * 20 байт + 4.56 млн * 20 байт)  -->
<!-- (2.16 млн * 1 байт + 11.04 млн * 68 байт + 4.56 млн * 12 байт)  -->
Суммарный суточный трафик (Гбайт/сутки):
|на сервер|от сервера|
|--|--|
|398|807|

*RPS в разбивке по типам запросов (запросов в секунду)*
<!-- 2.16 млн / 24 / 60 / 60 -->
<!-- 11.04 млн / 24 / 60 / 60 -->
<!-- 4.56 млн / 24 / 60 / 60 -->
|заказ такси| местоположение автомобилей|подсчет цены, примерного времени поездки для заданного маршрута|
|--|--|--|
|25|127.78|52.78|

**3. Логическая схем**
![LogicalDBScheme drawio](https://user-images.githubusercontent.com/85676494/201561935-63fa7481-03cb-4212-955d-c5543b16fab8.png)
**4. Физическая схем**
![PhysicalDBSchema drawio](https://user-images.githubusercontent.com/85676494/201561961-e808edad-bf22-49d7-849d-236ba823cb04.png)

Информация о водителях, машинах будет хранится в Tarantool, потому что их местоположение требуется часто обновлять, заказ часто меняет свой статус, поэтому он также вынесен в Tarantool.

ClickHouse - столбцовая система управления базами данных (СУБД) для онлайн обработки аналитических запросов (OLAP). В данном сервисе она используется для хранения информации об отзывах, поскольку именно эти данные имеет большое значение для аналитики поведения клиентов, водителей.

PostgreSQL является надежной, дисковой СУБД, она применяется для хранения данных, которые нечасто меняются и редко используются в аналитических запросах. Для вычислений с использованием геоданных используется расширение [PostGIS](https://habr.com/ru/post/228023/).

*Индексы:*

Tarantool:
order - индекс по id;
drivers - индекс по id;

ClickHouse:
clients_reviews - индекс по order_id;
drivers_reviews - индекс по order_id;

PostgreSQL:
client - индекс по id;

Шардирование: 
За историю существованя сервиса накопилось очень много данных о заказах, поэтому эту таблицу точно стоит шардировать на 500 шардов, примерно по миллиону записей в каждом.
Таблицу с пользователями разбиваем на 100 шардов, в каждом шарде немного больше миллиона записей.

**5. Технологии**
|Технология|Область применения|Мотивация|
|--|--|--|
|Go|Back-end|Язык с современной архитектурой, большим и активным сообществом. Имеет хорошую встренную асинхронность|
|PostGIS|обработка географических объектов в РСУБД PostgreSQL|Значительно упрощает работу с геоинформацией при использовании PostgreSQL|
|Tarantool|in-memory-вычисления|используется в местах, которые сильно ограничены временем, идеально подходит засчет своей производительности|
|ClickHouse|обработка аналитических запросов|производительность данной СУБД в аналитических запросах является её главным преимуществом|
|gRPC|удаленный вызов процедур|использование под капотом protocol buffers значительно ускоряет взаимодействие меджу микросервисами|
|Nginx|балансировка нагрузки|широко распространенный, производительный веб-сервер, имеющий функции балансировщика L7|

**6. Схема проекта**
![InteractionScheme drawio](https://user-images.githubusercontent.com/85676494/201561980-d0c02fc7-1edc-40c3-b130-06f33c7005b6.png)

**7. Список серверов**
*Балансировщик + фронтенд*
|Quantity|CPU (cores)|RAM (GB)|SSD (GB)|Throughput rate (MB/s)|
|--|--|--|--|--|
|2|24|32|256|256|

*Бэк-енд*
|Quantity|CPU (cores)|RAM (GB)|SSD (GB)|Throughput rate (MB/s)|
|--|--|--|--|--|
|4|24|32|1024|100|

*Сервис для вычисления маршрутов, расчета стоимости поездки (GeoComputer)*
|Quantity|CPU (cores)|RAM (GB)|SSD (GB)|Throughput rate (MB/s)|
|--|--|--|--|--|
|4|24|32|256|50|

Количество серверов расчитывется с учетом 2 реплик.

*PostgreSQL (без изображений)*
|Quantity|CPU (cores)|RAM (GB)|SSD (TB)|Throughput rate (MB/s)|
|--|--|--|--|--|
|30|16|32|5|100|

*PostgreSQL (хранение изображений)*
|Quantity|CPU (cores)|RAM (GB)|HDD (TB)|Throughput rate (MB/s)|
|--|--|--|--|--|
|15|16|32|2500|120|

